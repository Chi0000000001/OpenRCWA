# OpenRCWA 现代化改造计划 (Project Modernization Roadmap)

本文档根据项目目标，将改造任务分解为多个阶段和具体步骤，以便于跟踪和执行。

## 项目重构进展状态

### 已完成 ✅
1. **分层架构重构**：已完成 `core ⇆ model ⇆ geom ⇆ solve ⇆ backend` 的目录结构调整
2. **TensorMaterial 实现**：支持常数/函数/表格三种张量输入，包含完整的 Pydantic 验证
3. **层级旋转功能**：实现了 ZYX 欧拉角旋转，支持张量材料旋转和物理一致性验证
4. **SI 单位系统**：添加 `nm()`/`um()`/`mm()`/`deg()` 转换函数，强制 SI 单位校验
5. **测试套件**：新增 44 个测试用例全部通过，1 个跳过（求解器张量集成待完善）
6. **张量求解器集成**：✅ **新增** 核心适配器 (`rcwa/core/adapters.py`) 和求解器张量支持已实现
7. **求解器张量基础**：✅ **新增** MatrixCalculator 支持张量 P/Q 矩阵计算，能量守恒测试基础可运行
8. **HalfSpace 与简化 Stack**：✅ **新增** 实现显式 `HalfSpace` API，支持直观的 `superstrate/substrate` 语法
9. **复振幅信息完整保存**：✅ **已实现** 求解器已完整保存复振幅 `(rx,ry,rz,tx,ty,tz)` 并从复振幅派生强度量 `(R,T)`，确保无信息丢失，提供统一 Results 接口

### 当前架构问题与解决方案 🔧
1. **测试文件夹重复**：原有 `rcwa/test/` 和新建 `tests/` 已合并到统一的 `tests/` 目录
2. **循环导入解决**：通过调整导入路径和延迟导入解决了模块间循环依赖问题
3. **依赖管理**：配置独立虚拟环境，安装 pydantic、numpy、scipy 等核心依赖

### 接下来优先任务 🎯
1. **完善求解器张量集成**：✅ **张量材料求解器集成完成** 
2. **添加核心适配器**：✅ **核心适配器已实现**
3. **HalfSpace 与 Stack 简化**：✅ **HalfSpace API和材料工厂函数已实现**
4. **复振幅信息完整性**：✅ **复振幅信息已完整保存，强度量从复振幅派生，Results访问接口已确认**
5. **几何层开发**：阶段二的 `Shape` 和 `PatternedLayer` 实现已完成（见阶段二 任务 2.1）

## 核心设计原则

*   **分层架构**: 严格遵守 `core ⇆ model ⇆ geom ⇆ solve ⇆ backend` 的分层设计，确保模块间单向依赖：
    *   `core/`: 数值内核（求解器、矩阵运算），依赖 model 的只读属性
    *   `model/`: 数据模型与校验（Material/TensorMaterial/Layer），不依赖内核
    *   `geom/`: 几何定义与光栅化，产出卷积矩阵给核心使用
    *   `solve/`: 工作流引擎与结果处理，调用核心进行批量求解
    *   `backend/`: 计算后端抽象（NumPy/CuPy/JAX），被核心调用
*   **复振幅完整性**: **所有仿真结果必须完整保存复振幅信息** `(r_complex, t_complex)`，强度量 `(R, T, A, DE)` **始终从复振幅派生**。确保无信息丢失，支持相位敏感分析、偏振操作和高级光谱处理。
*   **统一结果接口**: 建立统一的 `Result` 数据结构，**强制包含复振幅**和派生强度量，提供一致的访问接口和转换方法。
*   **2D 周期性**: 核心 RCWA 引擎保持对 0D/1D/2D 周期性结构的支持，暂不扩展至 3D 周期。**严格保持层内 z 均匀假设**，通过多层堆叠实现复杂 3D 结构的近似。
*   **不可变性 (Immutability)**: 所有几何操作（如旋转、平移）都应返回新的对象实例，而不是在原对象上修改（in-place modification）。
*   **单位系统**: 统一使用 SI 单位（米），提供 `nm()`/`deg()` 语法糖仅在用户层，模型层使用 Pydantic 强校验。
*   **3D 结构策略**: 对于倾斜侧壁、斜坡等复杂 3D 几何，通过**自动 z 分片**将其分解为多个 z 均匀的 `PatternedLayer`，每层保持 RCWA 假设。

---

## 实施路线图 (Implementation Roadmap)

### 阶段一：核心数值能力扩展 (Core Numerical Enhancements)

此阶段专注于扩展底层的物理计算能力。

*   **任务 1.1: 支持各向异性材料 (Anisotropic Material)** ✅ **已完成**
    *   **目标**: 引入 `TensorMaterial`，在阶段一仅处理**层内均匀张量**（对角和非对角各向异性）。
    *   **具体行动**:
        *   [x] **创建 `TensorMaterial` 类**: 在 `rcwa/model/material.py` 中新增 `TensorMaterial`，支持 `epsilon(wl)` 返回一个 `(3, 3)` 的复数张量。
        *   [x] **扩展材料来源**: 确保 `TensorMaterial` 可以从常数（constant）、函数（function）和查表（table）三种方式构造。
        *   [x] **保持 S 矩阵逻辑**: 确认 `rcwa/core/matrices.py` 中的 S 矩阵（Redheffer star product）组合逻辑无需更改，因为它作用于模式（modes）而非材料本身。
        *   [x] **Pydantic 校验**: 在 `model/material.py` 中使用 Pydantic 对张量形状、频率范围、厚度等进行强校验。
        *   [x] **修改求解器**: 在 `rcwa/core/solver.py` 中，为均匀层的本征值问题（eigenproblem）增加处理张量介电常数的分支。**（已完成，能量守恒集成测试通过）**
    *   **验收标准**:
        *   [x] 单元测试：编写一个单元测试，将各向异性薄膜的反射/透射结果与基于菲涅尔方程/传输矩阵法（TMM）的解析解进行对比，验证其能量闭合（`|R+T+A-1| < 1e-6`）。
        *   [x] **复振幅完整性验证**: 确保所有仿真结果完整保存复振幅信息 `(r_complex, t_complex)`，强度量从复振幅派生。
        *   [x] 明确限制：阶段一仅支持层内均匀张量，各向异性图案层留待阶段二实现。

*   **任务 1.3: 复振幅信息完整性验证 (Complex Amplitude Completeness)** ✅ **已完成**
    *   **目标**: 确保所有仿真结果完整保存复振幅信息，强度量从复振幅派生，无信息丢失。
    *   **具体行动**:
        *   [x] **验证复振幅保存**: 确认 `solver.py` 的 `_append_results()` 完整保存 `(rx, ry, rz, tx, ty, tz)` 复振幅信息。
        *   [x] **验证派生计算**: 确认强度量 `(R, T)` 在 `_rt_quantities()` 中从复振幅通过 `calculateDiffractionReflectionEfficiency` 和 `calculateDiffractionTransmissionEfficiency` 计算得出。
        *   [x] **验证接口访问**: 确认 `Results` 类提供对复振幅 `results.rx` 和强度量 `results.R` 的统一访问接口。
        *   [x] **验证信息完整性**: 确认所有仿真过程中复振幅信息无损失，支持相位敏感分析。
    *   **验收标准**:
        *   [x] **复振幅完整性**: 所有仿真结果包含完整的 6 个复振幅分量 (rx,ry,rz,tx,ty,tz)。
        *   [x] **派生一致性**: 强度量 R, T 始终从复振幅计算，保证物理一致性。
        *   [x] **接口统一性**: Results 类提供对所有复振幅和强度量的一致访问。
        *   [x] **向后兼容性**: 现有代码和测试用例无需修改即可正常工作。
    *   **目标**: 允许用户旋转单个层，仅暴露**被动旋转 ZYX 欧拉角约定**，正确处理其对介电常数张量和倒格矢的影响。
    *   **具体行动**:
        *   [x] **创建 `model/transforms.py`**: 新增模块用于存放几何变换函数。
        *   [x] **实现 `rotate_layer`**: 在 `model/transforms.py` 中创建纯函数 `rotate_layer(layer, euler_angles, about="center")`，采用 ZYX 欧拉角约定。
        *   [x] **添加语法糖**: 在 `rcwa/model/layer.py` 的 `Layer` 类中添加 `.rotated(...)` 方法作为 `rotate_layer` 的便捷调用方式。
        *   [x] **处理均匀层旋转**: 对于均匀层，应用变换 `ε' = R * ε * R^T`。
        *   [x] **限制图案层旋转**: 对于图案层（PatternedLayer），初期仅支持面内旋转（绕 z 轴），并对 x/y 轴倾斜（tilt）抛出 `NotImplementedError`。
        *   [x] **同步 G 向量变换**: 旋转时同时影响倒格矢（G 向量）和必要的 Bloch 相位，确保物理一致性。
        *   [x] **明确旋转约定**: 文档强调"张量旋转 vs 几何旋转"的区别，采用被动旋转约定。
    *   **验收标准**:
        *   [x] 单元测试：验证旋转后的 `TensorMaterial` 的介电常数张量与预期一致。
        *   [x] 单元测试：验证旋转后图案层的倒格矢同步变换。
        *   [x] 文档：在文档中明确指出图案层旋转的限制和旋转约定。

### 阶段二：声明式几何层 (Declarative Geometry Layer)

此阶段的目标是建立一个从几何形状到 `epsilon(x, y)` 函数的桥梁，简化复杂结构的定义。

*   **任务 2.1: 抽象 `Shape` 与 `PatternedLayer`** ✅ 已完成
    *   **目标**: 创建一个高级 API，让用户通过组合基本形状来定义周期内图案。**完全支持离轴耦合和任意张量分布**。保持RCWA层内z均匀的核心假设，通过多层堆叠模拟复杂3D结构。
    *   **具体行动**:
        *   [x] **创建 `geom/shape.py`**: 定义 `Shape` 基类和子类：
            *   `Rectangle`, `Circle`, `Ellipse`: 基础几何图形
            *   **`Polygon`**: 支持任意顶点定义的多边形，包括凸多边形和简单凹多边形
            *   **`RegularPolygon`**: 正多边形（三角形、六边形等）的便捷构造器
            *   **`ComplexShape`**: 支持布尔运算（Union, Intersection, Difference）的复合形状
        *   [x] **增强多边形顶点支持**:
            *   **顶点定义**: `Polygon(vertices: List[Tuple[float, float]])` 支持任意顶点坐标列表
            *   **顶点校验**: 自动检测顶点顺序（顺时针/逆时针），确保正确的内外判断
            *   **简单多边形**: 检测并处理自相交多边形，提供警告或自动修正
            *   **凸包计算**: 提供 `.convex_hull()` 方法用于优化计算
            *   **边界精确性**: 使用高精度几何算法处理顶点在边界上的情况（修复水平边除零告警）
        *   [x] **实现 `.to_tensor_function()`**: 每个 `Shape` 对象都提供一个 `.to_tensor_function()` 方法，返回一个 `epsilon_tensor_fn(x, y)` → `(3, 3)` 复数张量函数，支持完整的各向异性材料分布。
        *   [x] **创建 `geom/patterned.py`**: 定义 `PatternedLayer` 类，严格保持**层内z均匀假设**。
        *   [x] **z分片接口**: 在 `PatternedLayer` 中新增 `z_slicing` 功能：
            *   **`get_cross_section(z_position)`**: 返回指定z位置的截面多边形
            *   **`generate_z_slices(z_positions)`**: 批量生成多个z截面的 `PatternedLayer` 列表
            *   **倾斜侧壁支持**: 通过线性插值顶点坐标，模拟倾斜或斜坡结构（新增 `TaperedPolygon`）
            *   **自动分层建议**: 根据几何复杂度建议合适的z分片数量
        *   [x] **实现完整张量光栅化**: `PatternedLayer` 接收 `(thickness, lattice, shapes, background_material)`，内部将多个 `epsilon_tensor_fn` 合并并采样到 2D 网格上，**每个像素存储完整的 3×3 张量**。
        *   [x] **支持离轴耦合**: 实现完整的 9 个张量分量的像素级光栅化，支持 εₓᵧ, εₓᵤ, εᵧᵤ 等离轴项的空间分布。
        *   [x] **产出张量卷积矩阵**: 将采样后的张量网格进行 FFT，生成 9 个分量的傅里叶系数卷积矩阵组 `{εₓₓ(G), εₓᵧ(G), εₓᵤ(G), εᵧₓ(G), εᵧᵧ(G), εᵧᵤ(G), εᵤₓ(G), εᵤᵧ(G), εᵤᵤ(G)}`，传递给核心的薄适配器接口。
        *   [x] **核心适配器**: 在 `rcwa/core/adapters.py` 中提供"用张量卷积矩阵建 Layer"的薄适配器，核心不感知 shape/raster 细节，但能处理完整的张量场分布。
    *   [ ] **优化存储**: 对于仅对角或部分对称的张量，提供存储优化选项，避免不必要的内存开销。（按要求暂缓）
    *   [x] **多层堆叠工具（基础）**: 通过 `PatternedLayer.generate_z_slices()` 提供分片切片基础能力，可在工作流中直接消费。
    *   **验收标准**:
    *   [x] 单元测试：验证 `Polygon` 类对复杂顶点定义（凸/凹多边形、自相交处理）的正确性（新增水平边健壮性处理）。
    *   [x] 单元测试：验证 `Shape.to_tensor_function()` 的输出张量形状和对称性（新增 `tests/test_shape_tensor_function.py`）。
    *   [x] 单元测试：验证 `PatternedLayer` 生成的 9 个张量卷积矩阵尺寸和关键值是否正确（覆盖）。
    *   [x] 单元测试：验证离轴耦合项（εₓᵧ 等）在非对称结构中的正确性（新增 `tests/test_offdiagonal_anisotropy.py`）。
    *   [x] 单元测试：验证 z 分片功能能正确处理倾斜侧壁和复杂 3D 形状（新增 `tests/test_z_slicing.py`）。
    *   [x] 明确区分：各向异性均匀层（阶段一）vs 各向异性图案层（阶段二）的测试分离（通过模块划分与测试命名完成）。

*   **任务 2.1+: 参数化多边形与布尔组合支持** ✅ 大部分已完成
    *   **目标**: 增强 `Shape` 与 `PatternedLayer` 的参数化与组合能力，支持动态几何参数扫描和复杂布尔运算。
    *   **具体行动**:
        *   [x] **参数化多边形接口**:
            *   已支持：`Polygon(vertices=callable, holes=callable)` 模板；`Polygon.from_template()`；统一 `.with_params()`
            *   已支持：`Rectangle/Circle/Ellipse/RegularPolygon` 参数更新（半径/宽高/旋转/中心）
        *   [x] **PatternedLayer 参数化**:
            *   已支持：`PatternedLayer.with_params()` 级联更新内部 `shapes` 与层级字段
            *   [ ] Sweep 集成与高阶缓存：将在 3.1 中统一提供
        *   [x] **布尔运算支持**:
            *   已支持：`UnionShape/IntersectionShape/DifferenceShape`，并实现参数级联 `with_params()`
        *   [x] **Polygon 多环轮廓**:
            *   已支持：`holes` 多环；外环 CCW、内孔 CW 自动校正；包含性校验与警告
    *   **验收标准**:
        *   [x] 参数化测试：参数化矩形/圆/正多边形可随参数变化
        *   [x] 布尔运算测试：差集用于掏孔（矩形掏圆孔、环形结构）正确
        *   [x] 卷积矩阵：参数变化后卷积矩阵可重新生成并通过测试
        *   [ ] 性能：参数扫描的跨运行缓存优化留待 5.2 实现

*   **任务 2.2: 确保几何与倒格矢一致性**
    *   **目标**: 在旋转等几何变换中，自动维护物理一致性。
    *   **具体行动**:
        *   [ ] **同步变换**: 当对 `PatternedLayer` 进行面内旋转时，确保其晶格（lattice）和倒格矢（reciprocal lattice vectors `G`）也同步旋转。
        *   [ ] **更新缓存键**: 确保所有缓存机制（如傅里叶系数缓存）的键（cache key）包含旋转角度、晶格、形状哈希和采样分辨率等所有影响最终结果的参数。
        *   [ ] **缓存失效策略**: 缓存键包含 `scene_hash`, `(λ, θ, φ)`, `truncation (Nx,Ny)`, `backend`, `precision`, `rotation`, `lattice`, `raster_res`, `cache_version`；任何变动均视为失效。
    *   **验收标准**:
        *   [ ] 单元测试：验证旋转后的 `PatternedLayer` 的倒格矢与预期一致。
        *   [ ] 单元测试：验证缓存在关键参数变化时正确失效。

### 阶段三：批量处理与结果分析 (Sweep & Results)

此阶段构建强大的工作流引擎和数据后处理工具。

*   **任务 3.1: 开发 `SweepEngine`**
    *   **目标**: 提供一个灵活的参数扫描引擎。
    *   **具体行动**:
        *   [ ] **创建 `solve/sweep.py`**: 定义 `Sweep` 类。
        *   [ ] **实现参数解析**: `Sweep(params: dict)` 能够解析多种扫描类型：
            *   连续参数：波长、角度、厚度等。
            *   离散结构：`[stack_A, stack_B, ...]`。
            *   混合扫描：自动计算上述参数的笛卡尔积。
        *   [ ] **实现 `.run(solver)` 方法**: 执行扫描任务。
        *   [ ] **并行化策略**: 在 `Sweep.run()` 提供 `backend="loky|thread|process"` 选择；默认 `loky`（joblib）以减少跨平台坑；确保对象可序列化（避免 lambda/局部函数）。
        *   [ ] **预编译优化**: 在并行前冻结常量编译产物（如卷积矩阵）以减少重复计算。
        *   [ ] **(选配) 断点续扫**: 实现将中间结果保存到磁盘，并能从断点恢复。
    *   **验收标准**:
        *   [ ] 示例：编写一个混合扫描（如波长 vs. 厚度）的示例脚本并验证结果。
        *   [ ] 跨平台测试：确保并行化在 Windows/macOS/Linux 上均正常工作。

*   **任务 3.2: 创建 `ResultGrid`**
    *   **目标**: 提供一个类似 `xarray` 的、带有多维坐标标签的友好结果容器，**强制包含复振幅信息**。
    *   **具体行动**:
        *   [ ] **创建 `solve/results.py`**: 定义 `ResultGrid` 类，**强制要求每个结果包含完整的复振幅信息**。
        *   [ ] **统一 Result 数据结构**: 建立标准的 `Result` 类，包含：
            *   **必需字段**: `r_complex` (反射复振幅), `t_complex` (透射复振幅), `wavelength`, `angle`, `polarization`
            *   **派生字段**: `R` (反射率), `T` (透射率), `A` (吸收率), `DE` (衍射效率) —— **全部从复振幅计算**
            *   **相位信息**: `r_phase`, `t_phase` (从复振幅提取相位)
            *   **元数据**: `backend`, `precision`, `convergence_info`
        *   [ ] **实现数据访问**: 内部用 `list[Result]` 存储数据，但对外提供 `.sel()` (按标签选择) 和 `.loc[]` (按标签索引) 和 `.isel[]` (按数值索引) 接口，对齐 pandas/xarray 习惯。
        *   [ ] **复振幅操作**: 提供便捷的复振幅操作方法：`.get_complex_amplitudes()`, `.get_phases()`, `.get_intensities()`。
        *   [ ] **实现格式转换**: 提供 `.to_dataframe()` 方法，方便与 Pandas 集成，**确保复振幅信息不丢失**。
        *   [ ] **实现绘图接口**: 提供便捷的 `.plot()` 方法，支持强度谱、相位谱和复平面图的可视化。
        *   [ ] **偏振与 CD 支持**: 在 `solve/source.py` 中定义 LCP/RCP，采用 IEEE/optics 约定：入射沿 +z，LCP = [1, i]/√2，RCP = [1, -i]/√2，**CD = T_RCP - T_LCP 基于复振幅计算**。
    *   **验收标准**:
        *   [ ] **复振幅完整性测试**: 验证所有 `Result` 对象都包含完整的复振幅信息，强度量与复振幅一致。
        *   [ ] 示例：使用 `ResultGrid` 对扫描结果进行切片、筛选和绘图，包括相位敏感分析。
        *   [ ] 单元测试：验证 LCP/RCP Jones 向量定义和基于复振幅的 CD 计算正确性。
        *   [ ] **信息无损测试**: 验证所有数据转换和操作过程中复振幅信息无损失。

### 阶段四：API 设计与用户体验 (API & UX)

此阶段的目标是封装底层复杂性，提供一个简洁、易用的顶层 API。

*   **任务 4.1: 设计顶层 API 门面 (Facade)**
    *   **目标**: 让用户通过 `import OpenRCWA as orcwa` 即可访问所有常用功能。
    *   **具体行动**:
        *   [ ] **编辑顶层 `__init__.py`**: 在 `rcwa/__init__.py` 中，明确导出一系列核心类和函数，如 `Material`, `TensorMaterial`, `Layer`, `PatternedLayer`, `Stack`, `Solver`, `Sweep`, `LCP`, `RCP`, `simulate` 等。
        *   [ ] **(选配) 惰性加载**: 对 JAX/CuPy 等重度依赖，考虑使用惰性导入（lazy import）机制，避免不必要的前置加载时间。
    *   **验收标准**:
        *   [ ] API可用性：`import OpenRCWA as orcwa; orcwa.Layer(...)` 可以成功调用。

*   **任务 4.2: 实现 `simulate()` 一键入口和 CLI**
    *   **目标**: 提供一个高度封装的函数和命令行工具，满足常见仿真需求。
    *   **具体行动**:
        *   [ ] **实现 `simulate()` 函数**: 创建 `simulate(stack, wavelength, ...)` 函数，封装 `Solver` 的设置和运行过程。
        *   [ ] **(选配) 创建 CLI 入口**: 利用 `argparse` 或 `click` 创建一个命令行工具 `orcwa sim scene.yaml`。
    *   **验收标准**:
        *   [ ] Quickstart 文档中的 "one-liner" 示例能成功运行。

*   **任务 4.3: 基于 Matplotlib 的 3D Stack 可视化**
    *   **目标**: 为用户提供一个直观的 3D 可视化接口，能够真实展示 Stack 中每一层的几何结构和厚度。用于仿真前的几何检查，防止输入错误；生成论文/汇报级科研插图，展示层次和 PatternedLayer 的图案。
    *   **具体行动**:
        *   [ ] **接口设计**: 新增 `rcwa/viz/show_stack3d(stack, cell_size=(Lx, Ly), alpha=0.7, save=None, **kwargs)`，返回 matplotlib Figure + Axes3D 对象。
        *   [ ] **层绘制逻辑**:
            *   **均匀层 (Layer)**: 绘制为 slab，厚度 = thickness，横向大小 = cell_size，颜色自动分配。
            *   **PatternedLayer**: 将 shapes 转换为多边形，并沿 z 方向挤出 (extrude)；背景材料绘制为 slab，pattern 形状在 slab 内"挖空"或"替换"为图案材料；支持掏孔 (holes) 与布尔组合。
            *   **HalfSpace**: 绘制为有限厚度 slab（例如 200 nm），并设置低透明度 (alpha=0.3)，避免"无限大"导致的视觉问题。
        *   [ ] **透明度与可见性**: 所有层默认半透明 (alpha=0.6~0.8)，保证能看清下方结构；PatternedLayer 背景与图案颜色对比明显，轮廓绘制黑色 wireframe；HalfSpace 透明度更低，暗示无限延伸。
        *   [ ] **坐标与堆叠**: z 方向自动累积层厚度，保持 Stack 顺序；等比例缩放，避免长宽高比例失真；支持整体 z_offset 移动。
        *   [ ] **配色与图例**: 每种 Material 分配唯一颜色，在图例中显示 Material.name，用户可覆盖颜色/透明度。
        *   [ ] **输出与保存**: 支持保存 PNG、PDF、SVG，保证科研插图可用；SVG 输出保证矢量清晰度；支持 dpi 设置。
    *   **验收标准**:
        *   [ ] 能正确绘制均匀层 + PatternedLayer + HalfSpace 的组合 stack。
        *   [ ] PatternedLayer 内几何（矩形、圆、多边形、孔洞）在 3D 可视化中真实可见。
        *   [ ] 半空间绘制为有限厚度 slab，并使用半透明颜色区分。
        *   [ ] 透明度默认设置下，下层结构仍然清晰可见。
        *   [ ] 教程输出图像达到论文插图质量，支持保存 PNG/SVG。

### 阶段五：性能与工程实践 (Performance & Engineering)

此阶段关注代码的性能、健壮性和可维护性。

*   **任务 5.1: 抽象计算后端**
    *   **目标**: 解耦数值计算与具体库（NumPy/CuPy/JAX），方便用户切换。
    *   **具体行动**:
        *   [ ] **创建后端接口**: 定义一个统一的 `linalg` 和 `fft` 接口。
        *   [ ] **实现 NumPy/SciPy 后端**: 作为默认的 CPU 后端。
        *   [ ] **(选配) 实现 CuPy 后端**: 为支持 NVIDIA GPU 加速。
        *   [ ] **(选配) 实现 JAX 后端**: 为支持自动微分和 XLA 编译。
    *   **验收标准**:
        *   [ ] 可以在 `simulate()` 或 `Solver` 中通过 `backend="numpy"` 或 `backend="cupy"` 参数切换后端，并得到一致的结果。

*   **任务 5.2: 实现缓存、日志与诊断**
    *   **目标**: 提升重复计算的效率，并提供丰富的运行时诊断信息。
    *   **具体行动**:
        *   [ ] **实现二级缓存**:
            *   缓存 1: `epsilon_fn → grid → Fourier` 的转换结果。
            *   缓存 2: 每个（层-频率）组合的本征模式和 S 矩阵。
        *   [ ] **缓存失效策略**: 缓存键包含 `scene_hash`, `(λ, θ, φ)`, `truncation (Nx,Ny)`, `backend`, `precision`, `rotation`, `lattice`, `raster_res`, `cache_version`；任何变动均视为失效。
        *   [ ] **实现日志系统**: 使用 Python 内置的 `logging` 模块，记录功率闭合、矩阵条件数、收敛过程等关键信息。
        *   [ ] **统一数据格式**: 使用 HDF5 或 NPZ 格式保存结果，并确保元数据（单位、角度、后端版本、随机种子等）被一同保存。
    *   **验收标准**:
        *   [ ] 多次运行相同仿真时，第二次运行速度显著快于第一次。
        *   [ ] 开启 `verbose` 或 `debug` 日志级别时，能看到详细的诊断输出。
        *   [ ] 缓存在算法更新后正确失效（通过 `cache_version` 控制）。

### 阶段六：文档与验证 (Documentation & Validation)

此阶段确保改造后的代码库质量过硬、文档清晰。

*   **任务 6.1: 完善测试套件**
    *   **目标**: 为所有新功能添加全面的测试。
    *   **具体行动**:
        *   [ ] **单元测试**: 覆盖 `TensorMaterial` 旋转、`Shape` 采样、缓存键一致性等。
        *   [ ] **属性测试**: 利用 `hypothesis` 等库，测试物理定律，如能量守恒、互易性和对称性。
        *   [ ] **回归测试**: 将所有示例脚本的输出光谱作为基线（baseline），在 CI 中进行比对，防止无意间的改动破坏结果。
    *   **验收标准**:
        *   [ ] CI 测试套件通过率 100%。

*   **任务 6.2: 撰写新版文档与示例**
    *   **目标**: 提供高质量的教程，展示新特性。
    *   **具体行动**:
        *   [ ] **撰写教程**:
            *   教程 A: 各向异性膜与层级旋转。
            *   教程 B: 使用 `Shape` 和 `PatternedLayer` 构建复杂光栅。
            *   教程 C: 使用 `SweepEngine` 和 `ResultGrid` 进行参数扫描与数据分析。
            *   教程 D: 计算圆二色性（CD）光谱。
            *   教程 E: 3D Stack 可视化与科研插图制作。
        *   [ ] **更新 API 文档**: 使用 Sphinx autodoc 自动生成所有新模块和类的 API 文档。
    *   **验收标准**:
        *   [ ] 所有新教程的代码示例都可以成功运行。
        *   [ ] Quickstart 文档代码行数少于 50 行。

---

## 当前状态总结

### **已完成的工作**
1. **分层架构重构完成**：所有模块已按照 `core ⇆ model ⇆ geom ⇆ solve ⇆ backend ⇆ legacy` 分层，解决循环依赖问题。
2. **TensorMaterial 实现完成**：支持常数/函数/表格三种输入，Pydantic 强校验张量形状、频率/厚度范围、SI 单位。
3. **层级旋转实现完成**：`rotate_layer` 函数和 `Layer.rotated()` 方法，支持 ZYX 欧拉角约定，处理张量变换和物理一致性。
4. **SI 单位系统添加**：新增 `nm()`, `um()`, `mm()`, `deg()` 单位转换函数，确保输入值的单位一致性。
5. **测试覆盖完成**：新增 `test_tensor_material.py`, `test_rotation.py`, `test_anisotropic_integration.py`, `test_tensor_validation.py`，所有测试通过。
6. **测试目录统一**：将 `rcwa/test/` 下的所有测试文件合并到项目根目录 `tests/`，统一测试入口。
7. **依赖管理完善**：安装 pydantic、numpy、scipy 等依赖，配置虚拟环境，确保新架构下的依赖一致性。

### **发现的问题**
1. **旧测试文件导入问题已解决**：修复了 `test_*harmonics.py` 和 `test_*grating.py` 文件中的过时导入路径
2. **架构重构完成**：所有模块已按分层架构调整，无循环依赖问题
3. **张量材料完全集成**：求解器已完全支持张量材料，包括P/Q矩阵计算和本征问题求解

### **优先任务**
1. **阶段一任务完成**：✅ 任务1.1（张量材料求解器集成）和任务1.3（复振幅信息完整性）已全部完成
2. **阶段二 2.1 已完成**：推进 2.1+（参数化/布尔增强）与 2.2（几何与倒格矢一致性）
3. **扩展工作流引擎**：开始阶段三的 `SweepEngine` 和 `ResultGrid` 开发

### **测试状态**
- 几何层（2.1）新增与更新的用例全部通过：geometry 模块 27 个用例通过（零告警）。

---

## 拟议文件结构变更

```
OpenRCWA/
├── rcwa/
│   ├── __init__.py           # 门面导出 (Facade exports)
│   │
│   ├── core/                 # 新增: 数值内核
│   │   ├── __init__.py
│   │   ├── solver.py         # 移至此处: 求解器核心逻辑
│   │   ├── matrices.py       # S 矩阵运算
│   │   └── adapters.py       # 薄适配器: 卷积矩阵→Layer
│   │
│   ├── model/                # 新增: 数据模型与校验
│   │   ├── __init__.py
│   │   ├── material.py       # 修改: 新增 TensorMaterial + Pydantic 校验
│   │   ├── layer.py          # 修改: 新增 .rotated() 语法糖 + 校验
│   │   └── transforms.py     # (e.g., rotate_layer)
│   │
│   ├── geom/                 # 新增: 几何定义
│   │   ├── __init__.py
│   │   ├── shape.py
│   │   └── patterned.py
│   │
│   ├── solve/                # 新增: 工作流与结果处理
│   │   ├── __init__.py
│   │   ├── sweep.py
│   │   ├── results.py
│   │   └── source.py         # LCP/RCP 定义与 CD 计算
│   │
│   ├── backend/              # 新增: 计算后端抽象
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── numpy_backend.py
│   │   └── cupy_backend.py
│   │
│   ├── viz/                  # 新增: 可视化与科研插图
│   │   ├── __init__.py
│   │   ├── stack3d.py        # 3D Stack 可视化
│   │   └── plotting.py       # 光谱绘图辅助函数
│   │
│   └── legacy/               # 临时: 现有文件逐步迁移
│       ├── crystal.py        # 待整合到 core/adapters.py
│       ├── grating.py        # 待整合或废弃
│       └── ...
│
├── docs/
│   └── source/
│       ├── tutorials/        # 新增: 新功能教程
│       │   ├── 01_anisotropy_rotation.rst
│       │   ├── 02_general_patterns.rst
│       │   ├── 03_sweeps_and_results.rst
│       │   ├── 04_circular_dichroism.rst
│       │   └── 05_3d_visualization.rst  # 新增: 3D可视化教程
│       └── api/              # 更新: API 文档
│
└── tests/
    ├── test_tensor_material.py # 新增
    ├── test_rotation.py        # 新增
    ├── test_shapes.py          # 新增
    ├── test_parametric_shapes.py # 新增: 参数化几何测试
    ├── test_boolean_operations.py # 新增: 布尔运算测试
    ├── test_cache_invalidation.py # 新增
    ├── test_visualization.py      # 新增: 3D可视化测试
    └── ...                     # (更多新测试)
```
