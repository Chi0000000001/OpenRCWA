# OpenRCWA 现代化改造计划 (Project Modernization Roadmap)

本文档根据项目目标，将改造任务分解为多个阶段和具体步骤，以便于跟踪和执行。

## 核心设计原则

*   **分层架构**: 严格遵守 `core ⇆ model ⇆ geom ⇆ solve ⇆ backend` 的分层设计，确保模块间单向依赖：
    *   `core/`: 数值内核（求解器、矩阵运算），依赖 model 的只读属性
    *   `model/`: 数据模型与校验（Material/TensorMaterial/Layer），不依赖内核
    *   `geom/`: 几何定义与光栅化，产出卷积矩阵给核心使用
    *   `solve/`: 工作流引擎与结果处理，调用核心进行批量求解
    *   `backend/`: 计算后端抽象（NumPy/CuPy/JAX），被核心调用
*   **2D 周期性**: 核心 RCWA 引擎保持对 0D/1D/2D 周期性结构的支持，暂不扩展至 3D 周期。
*   **不可变性 (Immutability)**: 所有几何操作（如旋转、平移）都应返回新的对象实例，而不是在原对象上修改（in-place modification）。
*   **单位系统**: 统一使用 SI 单位（米），提供 `nm()`/`deg()` 语法糖仅在用户层，模型层使用 Pydantic 强校验。

---

## 实施路线图 (Implementation Roadmap)

### 阶段一：核心数值能力扩展 (Core Numerical Enhancements)

此阶段专注于扩展底层的物理计算能力。

*   **任务 1.1: 支持各向异性材料 (Anisotropic Material)**
    *   **目标**: 引入 `TensorMaterial`，使其能够处理对角和非对角各向异性。
    *   **具体行动**:
        *   [ ] **创建 `TensorMaterial` 类**: 在 `rcwa/material.py` 中新增 `TensorMaterial`，支持 `epsilon(wl)` 返回一个 `(3, 3)` 的复数张量。
        *   [ ] **扩展材料来源**: 确保 `TensorMaterial` 可以从常数（constant）、函数（function）和查表（table）三种方式构造。
        *   [ ] **修改求解器**: 在 `rcwa/solver.py` 或相关模块中，为均匀层的本征值问题（eigenproblem）增加处理张量介电常数的分支。
        *   [ ] **保持 S 矩阵逻辑**: 确认 `rcwa/matrices.py` 中的 S 矩阵（Redheffer star product）组合逻辑无需更改，因为它作用于模式（modes）而非材料本身。
    *   **验收标准**:
        *   [ ] 单元测试：编写一个单元测试，将各向异性薄膜的反射/透射结果与基于菲涅尔方程/传输矩阵法（TMM）的解析解进行对比，验证其能量闭合（`|R+T+A-1| < 1e-6`）。

*   **任务 1.2: 实现层级旋转 (Layer Rotation)**
    *   **目标**: 允许用户旋转单个层，并正确处理其对介电常数张量的影响。
    *   **具体行动**:
        *   [ ] **创建 `model/transforms.py`**: 新增模块用于存放几何变换函数。
        *   [ ] **实现 `rotate_layer`**: 在 `model/transforms.py` 中创建纯函数 `rotate_layer(layer, euler_angles, about="center")`。
        *   [ ] **添加语法糖**: 在 `rcwa/layer.py` 的 `Layer` 类中添加 `.rotated(...)` 方法作为 `rotate_layer` 的便捷调用方式。
        *   [ ] **处理均匀层旋转**: 对于均匀层，应用变换 `ε' = R * ε * R^T`。
        *   [ ] **限制图案层旋转**: 对于图案层（PatternedLayer），初期仅支持面内旋转（绕 z 轴），并对 x/y 轴倾斜（tilt）抛出 `NotImplementedError`。
    *   **验收标准**:
        *   [ ] 单元测试：验证旋转后的 `TensorMaterial` 的介电常数张量与预期一致。
        *   [ ] 文档：在文档中明确指出图案层旋转的限制。

### 阶段二：声明式几何层 (Declarative Geometry Layer)

此阶段的目标是建立一个从几何形状到 `epsilon(x, y)` 函数的桥梁，简化复杂结构的定义。

*   **任务 2.1: 抽象 `Shape` 与 `PatternedLayer`**
    *   **目标**: 创建一个高级 API，让用户通过组合基本形状来定义周期内图案。
    *   **具体行动**:
        *   [ ] **创建 `geom/shape.py`**: 定义 `Shape` 基类和子类，如 `Rectangle`, `Circle`, `Polygon`。
        *   [ ] **实现 `.to_function()`**: 每个 `Shape` 对象都提供一个 `.to_function()` 方法，返回一个 `epsilon_fn(x, y)`，该函数根据坐标判断点是否在形状内部。
        *   [ ] **创建 `geom/patterned.py`**: 定义 `PatternedLayer` 类。
        *   [ ] **实现光栅化 (Rasterization)**: `PatternedLayer` 接收 `(thickness, lattice, shapes, background_material)`，内部将多个 `epsilon_fn` 合并并采样到 2D 网格上。
        *   [ ] **对接核心**: 将采样后的网格进行 FFT，生成傅里叶系数卷积矩阵，并将其传递给底层的 `Crystal` 或一个新的 `GeneralPattern` 适配器。
    *   **验收标准**:
        *   [ ] 单元测试：验证 `Shape.to_function()` 的输出在边界内外是否正确。
        *   [ ] 单元测试：验证 `PatternedLayer` 生成的卷积矩阵尺寸和关键值是否正确。

*   **任务 2.2: 确保几何与倒格矢一致性**
    *   **目标**: 在旋转等几何变换中，自动维护物理一致性。
    *   **具体行动**:
        *   [ ] **同步变换**: 当对 `PatternedLayer` 进行面内旋转时，确保其晶格（lattice）和倒格矢（reciprocal lattice vectors `G`）也同步旋转。
        *   [ ] **更新缓存键**: 确保所有缓存机制（如傅里叶系数缓存）的键（cache key）包含旋转角度、晶格、形状哈希和采样分辨率等所有影响最终结果的参数。
    *   **验收标准**:
        *   [ ] 单元测试：验证旋转后的 `PatternedLayer` 的倒格矢与预期一致。

### 阶段三：批量处理与结果分析 (Sweep & Results)

此阶段构建强大的工作流引擎和数据后处理工具。

*   **任务 3.1: 开发 `SweepEngine`**
    *   **目标**: 提供一个灵活的参数扫描引擎。
    *   **具体行动**:
        *   [ ] **创建 `solve/sweep.py`**: 定义 `Sweep` 类。
        *   [ ] **实现参数解析**: `Sweep(params: dict)` 能够解析多种扫描类型：
            *   连续参数：波长、角度、厚度等。
            *   离散结构：`[stack_A, stack_B, ...]`。
            *   混合扫描：自动计算上述参数的笛卡尔积。
        *   [ ] **实现 `.run(solver)` 方法**: 执行扫描任务。
        *   [ ] **(选配) 并行化**: 利用 `multiprocessing` 或 `joblib` 实现并行扫描。
        *   [ ] **(选配) 断点续扫**: 实现将中间结果保存到磁盘，并能从断点恢复。
    *   **验收标准**:
        *   [ ] 示例：编写一个混合扫描（如波长 vs. 厚度）的示例脚本并验证结果。

*   **任务 3.2: 创建 `ResultGrid`**
    *   **目标**: 提供一个类似 `xarray` 的、带有多维坐标标签的友好结果容器。
    *   **具体行动**:
        *   [ ] **创建 `solve/results.py`**: 定义 `ResultGrid` 类。
        *   [ ] **实现数据访问**: 内部用 `list[Result]` 存储数据，但对外提供 `.sel()` (按标签选择) 和 `._loc[]` (按下标选择) 接口。
        *   [ ] **实现格式转换**: 提供 `.to_dataframe()` 方法，方便与 Pandas 集成。
        *   [ ] **实现绘图接口**: 提供便捷的 `.plot()` 方法，用于快速可视化扫描结果。
    *   **验收标准**:
        *   [ ] 示例：使用 `ResultGrid` 对扫描结果进行切片、筛选和绘图。

### 阶段四：API 设计与用户体验 (API & UX)

此阶段的目标是封装底层复杂性，提供一个简洁、易用的顶层 API。

*   **任务 4.1: 设计顶层 API 门面 (Facade)**
    *   **目标**: 让用户通过 `import OpenRCWA as orcwa` 即可访问所有常用功能。
    *   **具体行动**:
        *   [ ] **编辑顶层 `__init__.py`**: 在 `rcwa/__init__.py` 中，明确导出一系列核心类和函数，如 `Material`, `TensorMaterial`, `Layer`, `PatternedLayer`, `Stack`, `Solver`, `Sweep`, `LCP`, `RCP`, `simulate` 等。
        *   [ ] **(选配) 惰性加载**: 对 JAX/CuPy 等重度依赖，考虑使用惰性导入（lazy import）机制，避免不必要的前置加载时间。
    *   **验收标准**:
        *   [ ] API可用性：`import OpenRCWA as orcwa; orcwa.Layer(...)` 可以成功调用。

*   **任务 4.2: 实现 `simulate()` 一键入口和 CLI**
    *   **目标**: 提供一个高度封装的函数和命令行工具，满足常见仿真需求。
    *   **具体行动**:
        *   [ ] **实现 `simulate()` 函数**: 创建 `simulate(stack, wavelength, ...)` 函数，封装 `Solver` 的设置和运行过程。
        *   [ ] **(选配) 创建 CLI 入口**: 利用 `argparse` 或 `click` 创建一个命令行工具 `orcwa sim scene.yaml`。
    *   **验收标准**:
        *   [ ] Quickstart 文档中的 "one-liner" 示例能成功运行。

### 阶段五：性能与工程实践 (Performance & Engineering)

此阶段关注代码的性能、健壮性和可维护性。

*   **任务 5.1: 抽象计算后端**
    *   **目标**: 解耦数值计算与具体库（NumPy/CuPy/JAX），方便用户切换。
    *   **具体行动**:
        *   [ ] **创建后端接口**: 定义一个统一的 `linalg` 和 `fft` 接口。
        *   [ ] **实现 NumPy/SciPy 后端**: 作为默认的 CPU 后端。
        *   [ ] **(选配) 实现 CuPy 后端**: 为支持 NVIDIA GPU 加速。
        *   [ ] **(选配) 实现 JAX 后端**: 为支持自动微分和 XLA 编译。
    *   **验收标准**:
        *   [ ] 可以在 `simulate()` 或 `Solver` 中通过 `backend="numpy"` 或 `backend="cupy"` 参数切换后端，并得到一致的结果。

*   **任务 5.2: 实现缓存、日志与诊断**
    *   **目标**: 提升重复计算的效率，并提供丰富的运行时诊断信息。
    *   **具体行动**:
        *   [ ] **实现二级缓存**:
            *   缓存 1: `epsilon_fn → grid → Fourier` 的转换结果。
            *   缓存 2: 每个（层-频率）组合的本征模式和 S 矩阵。
        *   [ ] **实现日志系统**: 使用 Python 内置的 `logging` 模块，记录功率闭合、矩阵条件数、收敛过程等关键信息。
        *   [ ] **统一数据格式**: 使用 HDF5 或 NPZ 格式保存结果，并确保元数据（单位、角度、后端版本、随机种子等）被一同保存。
    *   **验收标准**:
        *   [ ] 多次运行相同仿真时，第二次运行速度显著快于第一次。
        *   [ ] 开启 `verbose` 或 `debug` 日志级别时，能看到详细的诊断输出。

### 阶段六：文档与验证 (Documentation & Validation)

此阶段确保改造后的代码库质量过硬、文档清晰。

*   **任务 6.1: 完善测试套件**
    *   **目标**: 为所有新功能添加全面的测试。
    *   **具体行动**:
        *   [ ] **单元测试**: 覆盖 `TensorMaterial` 旋转、`Shape` 采样、缓存键一致性等。
        *   [ ] **属性测试**: 利用 `hypothesis` 等库，测试物理定律，如能量守恒、互易性和对称性。
        *   [ ] **回归测试**: 将所有示例脚本的输出光谱作为基线（baseline），在 CI 中进行比对，防止无意间的改动破坏结果。
    *   **验收标准**:
        *   [ ] CI 测试套件通过率 100%。

*   **任务 6.2: 撰写新版文档与示例**
    *   **目标**: 提供高质量的教程，展示新特性。
    *   **具体行动**:
        *   [ ] **撰写教程**:
            *   教程 A: 各向异性膜与层级旋转。
            *   教程 B: 使用 `Shape` 和 `PatternedLayer` 构建复杂光栅。
            *   教程 C: 使用 `SweepEngine` 和 `ResultGrid` 进行参数扫描与数据分析。
            *   教程 D: 计算圆二色性（CD）光谱。
        *   [ ] **更新 API 文档**: 使用 Sphinx autodoc 自动生成所有新模块和类的 API 文档。
    *   **验收标准**:
        *   [ ] 所有新教程的代码示例都可以成功运行。
        *   [ ] Quickstart 文档代码行数少于 50 行。

---

## 拟议文件结构变更

```
OpenRCWA/
├── rcwa/
│   ├── __init__.py           # 门面导出 (Facade exports)
│   ├── material.py           # 修改: 新增 TensorMaterial
│   ├── layer.py              # 修改: 新增 .rotated() 语法糖
│   ├── crystal.py            # 修改: 可能新增 GeneralPattern 适配器
│   ├── solver.py             # 修改: 增加张量处理分支
│   │
│   ├── geom/                 # 新增: 几何定义
│   │   ├── __init__.py
│   │   ├── shape.py
│   │   └── patterned.py
│   │
│   ├── model/                # 新增: 物理模型与变换
│   │   ├── __init__.py
│   │   └── transforms.py     # (e.g., rotate_layer)
│   │
│   ├── solve/                # 新增: 工作流与结果处理
│   │   ├── __init__.py
│   │   ├── sweep.py
│   │   ├── results.py
│   │   └── source.py         # (e.g., LCP, RCP)
│   │
│   └── backend/              # 新增: 计算后端抽象
│       ├── __init__.py
│       ├── base.py
│       ├── numpy_backend.py
│       └── cupy_backend.py
│
├── docs/
│   └── source/
│       ├── tutorials/        # 新增: 新功能教程
│       │   ├── 01_anisotropy_rotation.rst
│       │   ├── 02_general_patterns.rst
│       │   ├── 03_sweeps_and_results.rst
│       │   └── 04_circular_dichroism.rst
│       └── api/              # 更新: API 文档
│
└── tests/
    ├── test_tensor_material.py # 新增
    ├── test_rotation.py        # 新增
    ├── test_shapes.py          # 新增
    └── ...                     # (更多新测试)
```
